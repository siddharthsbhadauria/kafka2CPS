import os
import json
import azure.functions as func
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient

def main(req: func.HttpRequest) -> func.HttpResponse:
    try:
        # Get source and destination blob details from the request
        source_account_name = req.params.get('source_account_name')
        source_container_name = req.params.get('source_container_name')
        source_blob_name = req.params.get('source_blob_name')

        dest_account_name = req.params.get('dest_account_name')
        dest_container_name = req.params.get('dest_container_name')
        dest_blob_name = req.params.get('dest_blob_name')

        # Get Managed Identity credentials
        credential = DefaultAzureCredential()

        # Source blob
        source_blob_service_client = BlobServiceClient(account_url=f"https://{source_account_name}.blob.core.windows.net", credential=credential)
        source_blob_client = source_blob_service_client.get_blob_client(container=source_container_name, blob=source_blob_name)

        # Destination blob
        dest_blob_service_client = BlobServiceClient(account_url=f"https://{dest_account_name}.blob.core.windows.net", credential=credential)
        dest_blob_client = dest_blob_service_client.get_blob_client(container=dest_container_name, blob=dest_blob_name)

        # Copy blob
        dest_blob_client.start_copy_from_url(source_blob_client.url)

        return func.HttpResponse(f"Blob copy initiated from {source_blob_client.url} to {dest_blob_client.url}", status_code=200)

    except Exception as e:
        return func.HttpResponse(f"Error: {str(e)}", status_code=500)
